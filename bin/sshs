#!/bin/bash

# ---- 參數處理 ----
action="$1"
input_user="$2"
input_server="$3"

# 讀取 /etc/hosts 中的 server 資訊
servers=()
while read -r line; do
  [[ "$line" =~ ^#.*$ || -z "$line" ]] && continue
  ip=$(echo "$line" | awk '{print $1}')
  name=$(echo "$line" | awk '{print $2}')
  servers+=("$ip $name")
done < /etc/hosts

if [ ${#servers[@]} -eq 0 ]; then
  echo "❌ 找不到任何主機定義於 /etc/hosts"
  exit 1
fi

# 如果第一個參數是 print
if [ "$action" == "print" ]; then
  echo "🔍 可用伺服器列表："
  for i in "${!servers[@]}"; do
    ip=$(echo "${servers[$i]}" | awk '{print $1}')
    name=$(echo "${servers[$i]}" | awk '{print $2}')
    echo "$((i+1)). $name ($ip)"
  done

  echo
  echo "✅ 登入範例（請依實際修改 user 與 server）："
  echo "ssh user@server"
  exit 0
fi

# 如果 user + server 都有帶，直接連線
if [ -n "$action" ] && [ -n "$input_user" ] && [ -n "$input_server" ]; then
  user="$action"
  server="$input_user"

  # 查找 server 對應的 IP
  match_line=""
  for entry in "${servers[@]}"; do
    name=$(echo "$entry" | awk '{print $2}')
    if [ "$name" == "$server" ]; then
      match_line="$entry"
      break
    fi
  done

  if [ -z "$match_line" ]; then
    echo "❌ 找不到主機 '$server'"
    exit 1
  fi

  ip=$(echo "$match_line" | awk '{print $1}')
  hostname=$(echo "$match_line" | awk '{print $2}')

  echo "🔐 正在直接連線：$user@$hostname ($ip)"
  ssh "$user@$hostname"
  exit 0
fi

# ---- 如果沒帶參數，互動模式 ----
echo "🔍 可用伺服器列表："
for i in "${!servers[@]}"; do
  ip=$(echo "${servers[$i]}" | awk '{print $1}')
  name=$(echo "${servers[$i]}" | awk '{print $2}')
  echo "$((i+1)). $name ($ip)"
done

read -p "請選擇伺服器編號: " choice
if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt ${#servers[@]} ]; then
  echo "❌ 無效的選擇"
  exit 1
fi

selected="${servers[$((choice-1))]}"
ip=$(echo "$selected" | awk '{print $1}')
hostname=$(echo "$selected" | awk '{print $2}')

read -p "請輸入要使用的使用者帳號: " ssh_user

echo "🔐 正在連線：$ssh_user@$hostname ($ip)"
ssh "$ssh_user@$hostname"

