#!/bin/bash

arg1="$1"
arg2="$2"

# ---- 自動推論參數 ----
if [ -n "$arg1" ] && [ -z "$arg2" ]; then
  input_user="root"
  input_server="$arg1"
elif [ -n "$arg1" ] && [ -n "$arg2" ]; then
  input_user="$arg1"
  input_server="$arg2"
fi

# ---- 讀取 /etc/hosts ----
servers=()
while read -r line; do
  [[ "$line" =~ ^#.*$ || -z "$line" ]] && continue
  [[ "$line" =~ ^127\..* ]] && continue
  [[ "$line" =~ ^::.*$ || "$line" =~ ^fe00:: || "$line" =~ ^ff0[0-9]:: || "$line" =~ ^ff02:: ]] && continue

  ip=$(echo "$line" | awk '{print $1}')
  name=$(echo "$line" | awk '{print $2}')
  [[ -n "$ip" && -n "$name" ]] && servers+=("$ip $name")
done < /etc/hosts

if [ ${#servers[@]} -eq 0 ]; then
  echo "❌ 找不到任何主機定義於 /etc/hosts"
  exit 1
fi

# 顯示主機列表
print_servers() {
  echo "🔍 可用伺服器列表："
  for i in "${!servers[@]}"; do
    ip=$(echo "${servers[$i]}" | awk '{print $1}')
    name=$(echo "${servers[$i]}" | awk '{print $2}')
    echo "$((i+1)). $name ($ip)"
  done
}

# 找出 IP
find_ip_by_name() {
  for entry in "${servers[@]}"; do
    name=$(echo "$entry" | awk '{print $2}')
    ip=$(echo "$entry" | awk '{print $1}')
    if [ "$name" == "$1" ]; then
      echo "$ip"
      return
    fi
  done
  echo ""
}

# ---- 參數模式 ----
if [ -n "$input_user" ] && [ -n "$input_server" ]; then
  ip=$(find_ip_by_name "$input_server")
  if [ -z "$ip" ]; then
    echo "❌ 找不到主機 '$input_server'"
    exit 1
  fi
  echo "🔐 正在連線：$input_user@$input_server ($ip)"
  start_time=$(date +%s)
  ssh "$input_user@$input_server"
  end_time=$(date +%s)
  duration=$((end_time - start_time))
  echo "✅ 連線結束，花費時間：${duration} 秒"
  exit 0
fi

# ---- 互動模式 ----
print_servers
read -p "請選擇伺服器編號: " choice
if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt ${#servers[@]} ]; then
  echo "❌ 無效的選擇"
  exit 1
fi

selected="${servers[$((choice-1))]}"
ip=$(echo "$selected" | awk '{print $1}')
hostname=$(echo "$selected" | awk '{print $2}')

read -p "請輸入要使用的使用者帳號 (預設: root): " ssh_user
ssh_user="${ssh_user:-root}"

echo "🔐 正在連線：$ssh_user@$hostname ($ip)"
start_time=$(date +%s)
ssh "$ssh_user@$hostname"
end_time=$(date +%s)
duration=$((end_time - start_time))
echo "✅ 連線結束，花費時間：${duration} 秒"
