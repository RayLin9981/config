#!/bin/bash

# æª¢æŸ¥ä¸¦è§£æåƒæ•¸
action="$1"
input_server="$2"

# è®€å– /etc/hostsï¼Œæ’é™¤ 127.x.x.xã€localhostã€IPv6
servers=()
while read -r line; do
  [[ "$line" =~ ^#.*$ || -z "$line" ]] && continue
  [[ "$line" =~ ^127\. ]] && continue
  [[ "$line" =~ localhost ]] && continue
  [[ "$line" =~ ^::.*$ || "$line" =~ ^fe00:: || "$line" =~ ^ff0[0-9]:: || "$line" =~ ^ff02:: ]] && continue

  ip=$(echo "$line" | awk '{print $1}')
  name=$(echo "$line" | awk '{print $2}')
  [[ -n "$ip" && -n "$name" ]] && servers+=("$ip $name")
done < /etc/hosts

if [ ${#servers[@]} -eq 0 ]; then
  echo "âŒ /etc/hosts ä¸­æ‰¾ä¸åˆ°ä»»ä½•ä¸»æ©Ÿè³‡è¨Š"
  exit 1
fi

# è‹¥æ²’åƒæ•¸å‰‡é€²å…¥äº’å‹•æ¨¡å¼
if [ -z "$action" ]; then
  echo "ğŸ” å¯ç”¨ä¸»æ©Ÿåˆ—è¡¨ï¼š"
  for i in "${!servers[@]}"; do
    ip=$(echo "${servers[$i]}" | awk '{print $1}')
    name=$(echo "${servers[$i]}" | awk '{print $2}')
    echo "$((i+1)). $name ($ip)"
  done

  read -p "è«‹é¸æ“‡ä¸»æ©Ÿç·¨è™Ÿ: " choice
  if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt ${#servers[@]} ]; then
    echo "âŒ ç„¡æ•ˆçš„é¸æ“‡"
    exit 1
  fi

  selected="${servers[$((choice-1))]}"
  ip=$(echo "$selected" | awk '{print $1}')
  hostname=$(echo "$selected" | awk '{print $2}')
  read -p "è«‹è¼¸å…¥ä½¿ç”¨è€…ï¼ˆé è¨­ rootï¼‰: " ssh_user
  ssh_user=${ssh_user:-root}
else
  if [ -z "$input_server" ]; then
    ssh_user="root"
    hostname="$action"
  else
    ssh_user="$action"
    hostname="$input_server"
  fi

  found_entry=""
  for entry in "${servers[@]}"; do
    name=$(echo "$entry" | awk '{print $2}')
    if [ "$name" == "$hostname" ]; then
      found_entry="$entry"
      break
    fi
  done

  if [ -z "$found_entry" ]; then
    echo "âŒ æ‰¾ä¸åˆ°ä¸»æ©Ÿ '$hostname'"
    exit 1
  fi

  ip=$(echo "$found_entry" | awk '{print $1}')
fi

TARGET="$ssh_user@$hostname"

echo "â³ ç­‰å¾… SSH å¯ç”¨ï¼š$TARGET"

START_TIME=$(date +%s)

# æŒçºŒæ¸¬è©¦é€£ç·šç›´åˆ°æˆåŠŸ

while true; do
  ssh -o ConnectTimeout=5 \
      -o BatchMode=yes \
      -o StrictHostKeyChecking=no \
      "$TARGET" exit >/dev/null 2>&1

  status=$?

  if [ $status -eq 0 ]; then
    echo  # è®“é»çµæŸå¾Œæ›è¡Œ
    echo "âœ… SSH æˆåŠŸé€£ç·šï¼ˆå…å¯†ç¢¼ï¼‰"
    break
  elif [ $status -eq 255 ]; then
    # é¡å¤–å–å¾—éŒ¯èª¤è¨Šæ¯ä¾†åˆ¤æ–·
    OUTPUT=$(ssh -o ConnectTimeout=5 \
                 -o BatchMode=yes \
                 -o StrictHostKeyChecking=no \
                 "$TARGET" exit 2>&1)

    if echo "$OUTPUT" | grep -qi "Permission denied"; then
      echo
      echo "ğŸš« ç„¡æ³•å…å¯†ç¢¼ç™»å…¥ï¼ˆéœ€è¦å¯†ç¢¼ï¼‰"
      SKIP_WAIT=true
      break
    elif echo "$OUTPUT" | grep -qiE "Connection refused|No route to host|Connection timed out"; then
      echo -n "x"  # è¡¨ç¤ºé€£ç·šå•é¡Œ
    else
      echo -n "?"  # å…¶ä»–æœªçŸ¥éŒ¯èª¤
    fi
  else
    echo -n "."  # å…¶ä»–é‡è©¦
  fi

  sleep 5
done

END_TIME=$(date +%s)
WAIT_TIME=$((END_TIME - START_TIME))

echo
echo "âœ… SSH å¯ç”¨ï¼Œè€—æ™‚ $WAIT_TIME ç§’ã€‚"

# å˜—è©¦ç™»å…¥
echo "ğŸ” ç™»å…¥ä¸­ï¼š$TARGET"
ssh "$TARGET"
EXIT_CODE=$?

# è‹¥é€£ç·šå¤±æ•—ï¼Œæª¢æŸ¥æ˜¯å¦æ˜¯ host key è¡çª
if [ $EXIT_CODE -ne 0 ]; then
  echo "âš ï¸ å˜—è©¦æª¢æŸ¥æ˜¯å¦ç‚º SSH key è¡çª..."
  SSH_ERR=$(ssh "$TARGET" 2>&1)

  if echo "$SSH_ERR" | grep -q "Offending"; then
    echo "ğŸ§¹ æ¸…ç† known_hosts ä¸­çš„ '$hostname' å’Œ '$ip'"
    ssh-keygen -R "$hostname"
    ssh-keygen -R "$ip"
    echo "ğŸ” é‡æ–°å˜—è©¦ç™»å…¥..."
    ssh "$TARGET"
  else
    echo "âŒ ç„¡æ³•ç™»å…¥ï¼š$SSH_ERR"
    exit 1
  fi
fi
