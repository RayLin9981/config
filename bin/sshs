#!/bin/bash

# ---- åƒæ•¸è™•ç† ----
action="$1"
input_user="$2"
input_server="$3"

# è®€å– /etc/hosts ä¸­çš„ server è³‡è¨Š
servers=()
while read -r line; do
  [[ "$line" =~ ^#.*$ || -z "$line" ]] && continue
  ip=$(echo "$line" | awk '{print $1}')
  name=$(echo "$line" | awk '{print $2}')
  servers+=("$ip $name")
done < /etc/hosts

if [ ${#servers[@]} -eq 0 ]; then
  echo "âŒ æ‰¾ä¸åˆ°ä»»ä½•ä¸»æ©Ÿå®šç¾©æ–¼ /etc/hosts"
  exit 1
fi

# å¦‚æœç¬¬ä¸€å€‹åƒæ•¸æ˜¯ print
if [ "$action" == "print" ]; then
  echo "ğŸ” å¯ç”¨ä¼ºæœå™¨åˆ—è¡¨ï¼š"
  for i in "${!servers[@]}"; do
    ip=$(echo "${servers[$i]}" | awk '{print $1}')
    name=$(echo "${servers[$i]}" | awk '{print $2}')
    echo "$((i+1)). $name ($ip)"
  done

  echo
  echo "âœ… ç™»å…¥ç¯„ä¾‹ï¼ˆè«‹ä¾å¯¦éš›ä¿®æ”¹ user èˆ‡ serverï¼‰ï¼š"
  echo "ssh user@server"
  exit 0
fi

# å¦‚æœ user + server éƒ½æœ‰å¸¶ï¼Œç›´æ¥é€£ç·š
if [ -n "$action" ] && [ -n "$input_user" ] && [ -n "$input_server" ]; then
  user="$action"
  server="$input_user"

  # æŸ¥æ‰¾ server å°æ‡‰çš„ IP
  match_line=""
  for entry in "${servers[@]}"; do
    name=$(echo "$entry" | awk '{print $2}')
    if [ "$name" == "$server" ]; then
      match_line="$entry"
      break
    fi
  done

  if [ -z "$match_line" ]; then
    echo "âŒ æ‰¾ä¸åˆ°ä¸»æ©Ÿ '$server'"
    exit 1
  fi

  ip=$(echo "$match_line" | awk '{print $1}')
  hostname=$(echo "$match_line" | awk '{print $2}')

  echo "ğŸ” æ­£åœ¨ç›´æ¥é€£ç·šï¼š$user@$hostname ($ip)"
  ssh "$user@$hostname"
  exit 0
fi

# ---- å¦‚æœæ²’å¸¶åƒæ•¸ï¼Œäº’å‹•æ¨¡å¼ ----
echo "ğŸ” å¯ç”¨ä¼ºæœå™¨åˆ—è¡¨ï¼š"
for i in "${!servers[@]}"; do
  ip=$(echo "${servers[$i]}" | awk '{print $1}')
  name=$(echo "${servers[$i]}" | awk '{print $2}')
  echo "$((i+1)). $name ($ip)"
done

read -p "è«‹é¸æ“‡ä¼ºæœå™¨ç·¨è™Ÿ: " choice
if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt ${#servers[@]} ]; then
  echo "âŒ ç„¡æ•ˆçš„é¸æ“‡"
  exit 1
fi

selected="${servers[$((choice-1))]}"
ip=$(echo "$selected" | awk '{print $1}')
hostname=$(echo "$selected" | awk '{print $2}')

read -p "è«‹è¼¸å…¥è¦ä½¿ç”¨çš„ä½¿ç”¨è€…å¸³è™Ÿ: " ssh_user

echo "ğŸ” æ­£åœ¨é€£ç·šï¼š$ssh_user@$hostname ($ip)"
ssh "$ssh_user@$hostname"

