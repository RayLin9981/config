#!/bin/bash

arg1="$1"
arg2="$2"

# ---- è‡ªå‹•æ¨è«–åƒæ•¸ ----
if [ -n "$arg1" ] && [ -z "$arg2" ]; then
  input_user="root"
  input_server="$arg1"
elif [ -n "$arg1" ] && [ -n "$arg2" ]; then
  input_user="$arg1"
  input_server="$arg2"
fi

# ---- è®€å– /etc/hosts ----
servers=()
while read -r line; do
  [[ "$line" =~ ^#.*$ || -z "$line" ]] && continue
  [[ "$line" =~ ^127\..* ]] && continue
  [[ "$line" =~ ^::.*$ || "$line" =~ ^fe00:: || "$line" =~ ^ff0[0-9]:: || "$line" =~ ^ff02:: ]] && continue

  ip=$(echo "$line" | awk '{print $1}')
  name=$(echo "$line" | awk '{print $2}')
  [[ -n "$ip" && -n "$name" ]] && servers+=("$ip $name")
done < /etc/hosts

if [ ${#servers[@]} -eq 0 ]; then
  echo "âŒ æ‰¾ä¸åˆ°ä»»ä½•ä¸»æ©Ÿå®šç¾©æ–¼ /etc/hosts"
  exit 1
fi

# é¡¯ç¤ºä¸»æ©Ÿåˆ—è¡¨
print_servers() {
  echo "ğŸ” å¯ç”¨ä¼ºæœå™¨åˆ—è¡¨ï¼š"
  for i in "${!servers[@]}"; do
    ip=$(echo "${servers[$i]}" | awk '{print $1}')
    name=$(echo "${servers[$i]}" | awk '{print $2}')
    echo "$((i+1)). $name ($ip)"
  done
}

# æ‰¾å‡º IP
find_ip_by_name() {
  for entry in "${servers[@]}"; do
    name=$(echo "$entry" | awk '{print $2}')
    ip=$(echo "$entry" | awk '{print $1}')
    if [ "$name" == "$1" ]; then
      echo "$ip"
      return
    fi
  done
  echo ""
}

# ---- åƒæ•¸æ¨¡å¼ ----
if [ -n "$input_user" ] && [ -n "$input_server" ]; then
  ip=$(find_ip_by_name "$input_server")
  if [ -z "$ip" ]; then
    echo "âŒ æ‰¾ä¸åˆ°ä¸»æ©Ÿ '$input_server'"
    exit 1
  fi
  echo "ğŸ” æ­£åœ¨é€£ç·šï¼š$input_user@$input_server ($ip)"
  start_time=$(date +%s)
  ssh "$input_user@$input_server"
  end_time=$(date +%s)
  duration=$((end_time - start_time))
  echo "âœ… é€£ç·šçµæŸï¼ŒèŠ±è²»æ™‚é–“ï¼š${duration} ç§’"
  exit 0
fi

# ---- äº’å‹•æ¨¡å¼ ----
print_servers
read -p "è«‹é¸æ“‡ä¼ºæœå™¨ç·¨è™Ÿ: " choice
if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt ${#servers[@]} ]; then
  echo "âŒ ç„¡æ•ˆçš„é¸æ“‡"
  exit 1
fi

selected="${servers[$((choice-1))]}"
ip=$(echo "$selected" | awk '{print $1}')
hostname=$(echo "$selected" | awk '{print $2}')

read -p "è«‹è¼¸å…¥è¦ä½¿ç”¨çš„ä½¿ç”¨è€…å¸³è™Ÿ (é è¨­: root): " ssh_user
ssh_user="${ssh_user:-root}"

echo "ğŸ” æ­£åœ¨é€£ç·šï¼š$ssh_user@$hostname ($ip)"
start_time=$(date +%s)
ssh "$ssh_user@$hostname"
end_time=$(date +%s)
duration=$((end_time - start_time))
echo "âœ… é€£ç·šçµæŸï¼ŒèŠ±è²»æ™‚é–“ï¼š${duration} ç§’"
